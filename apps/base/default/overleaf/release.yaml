---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: overleaf
  namespace: default
spec:
  chart:
    spec:
      chart: overleaf
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: k8s-at-home
        namespace: flux-system
      version: '3.1.2'
  install:
    crds: Create
  interval: 30m
  releaseName: overleaf
  targetNamespace: default
  upgrade:
    crds: CreateReplace
  values:
    image:
      repository: tuetenk0pp/sharelatex-full
      tag: 3.1.0.3
      pullPolicy: IfNotPresent
    env:
      REDIS_HOST: overleaf-redis-master
      SHARELATEX_MONGO_URL: mongodb://overleaf-mongodb/sharelatex
      SHARELATEX_REDIS_HOST: overleaf-redis-master
    mongodb:
      enabled: true
    redis:
      enabled: true
      master:
        persistence:
          enabled: true
          storageClass: openebs-local-hostpath-conf
          existingClaim: openebs-local-hostpath-conf-pvc
          subPath: 'overleaf/redis-master'
      replica:
        persistence:
          enabled: true
          storageClass: openebs-local-hostpath-conf
          existingClaim: openebs-local-hostpath-conf-pvc
          subPath: 'overleaf/redis-replica'
    ingress:
      main:
        enabled: true
        ingressClassName: nginx
        annotations:
          nginx.ingress.kubernetes.io/proxy-read-timeout: '3600' # Recommendation for Websockets
          nginx.ingress.kubernetes.io/proxy-send-timeout: '3600' # Recommendation for Websockets
          nginx.ingress.kubernetes.io/proxy-body-size: 100m
          cert-manager.io/cluster-issuer: letsencrypt-staging
          flame.pawelmalak/type: application
          flame.pawelmalak/name: Overleaf
          flame.pawelmalak/url: https://example.com # change later
          flame.pawelmalak/icon: https://nodesk.co/remote-companies/assets/logos/overleaf.c23e764e96ecc7507e702b5d55072de821ccfb2d72d1582eded3c85cdb83395a.png
        hosts:
          - host: 'example.com' # change later
            paths:
              - path: /
        tls:
          - hosts:
              - 'example.com' # change later
            secretName: overleaf-tls

# https://overleaf.int.sambaum.ch/launchpad
