server:
  http_listen_port: 9080
  grpc_listen_port: 0
clients:
- url: http://loki:3100/loki/api/v1/push
positions:
  filename: /tmp/positions.yaml
target_config:
  sync_period: 10s
scrape_configs:
- job_name: pod-logs
  kubernetes_sd_configs:
  - role: pod
  pipeline_stages:
  - docker: {}
  relabel_configs:
  - source_labels:
    - __meta_kubernetes_pod_node_name
    target_label: __host__
  - action: labelmap
    regex: __meta_kubernetes_pod_label_(.+)
  - action: replace
    replacement: $1
    separator: /
    source_labels:
    - __meta_kubernetes_namespace
    - __meta_kubernetes_pod_name
    target_label: job
  - action: replace
    source_labels:
    - __meta_kubernetes_namespace
    target_label: namespace
  - action: replace
    source_labels:
    - __meta_kubernetes_pod_name
    target_label: pod
  - action: replace
    source_labels:
    - __meta_kubernetes_pod_container_name
    target_label: container
  - replacement: /var/log/pods/*$1/*.log
    separator: /
    source_labels:
    - __meta_kubernetes_pod_uid
    - __meta_kubernetes_pod_container_name
    target_label: __path__

- job_name: syslog-tcp
  syslog:
    listen_address: 0.0.0.0:1514
    listen_protocol: tcp
    idle_timeout: 60s
    label_structured_data: true
    labels:
      job: syslog
      protocol: tcp
  relabel_configs:
  - source_labels: [ '__syslog_message_hostname' ]
    target_label: host
  - source_labels: [ '__syslog_message_severity' ]
    target_label: severity
  - source_labels: [ '__syslog_message_facility' ]
    target_label: facility

  pipeline_stages:
  # Try RFC5424 first
  - match:
      selector: '{job="syslog"}'
      stages:
      - regex:
          expression: '^\<\d+\>1\s+(?P<timestamp>\S+)\s+(?P<host>\S+)\s+(?P<app>\S+)\s+(?P<pid>\S+)\s+(?P<msgid>\S+)\s+(?P<sd>\[.*\]|-)\s+(?P<message>.*)'
      - labels:
          host:
          app: # Fall back to RFC3164
  - match:
      selector: '{job="syslog", app=""}'
      stages:
      - regex:
          expression: '^(?P<timestamp>\w+\s+\d+\s+[\d:]+)\s+(?P<host>\S+)\s+(?P<tag>[^\[:\s]+)(?:\[(?P<pid>\d+)\])?[:\s]+(?P<message>.*)'
      - labels:
          host:
          app: tag

- job_name: syslog-udp
  syslog:
    listen_address: 0.0.0.0:1514
    listen_protocol: udp
    idle_timeout: 60s
    label_structured_data: true
    labels:
      job: syslog
      protocol: udp
  relabel_configs:
  - source_labels: [ '__syslog_message_hostname' ]
    target_label: host
  - source_labels: [ '__syslog_message_severity' ]
    target_label: severity
  - source_labels: [ '__syslog_message_facility' ]
    target_label: facility

  pipeline_stages:
  # Try RFC5424 first
  - match:
      selector: '{job="syslog"}'
      stages:
      - regex:
          expression: '^\<\d+\>1\s+(?P<timestamp>\S+)\s+(?P<host>\S+)\s+(?P<app>\S+)\s+(?P<pid>\S+)\s+(?P<msgid>\S+)\s+(?P<sd>\[.*\]|-)\s+(?P<message>.*)'
      - labels:
          host:
          app: # Fall back to RFC3164
  - match:
      selector: '{job="syslog", app=""}'
      stages:
      - regex:
          expression: '^(?P<timestamp>\w+\s+\d+\s+[\d:]+)\s+(?P<host>\S+)\s+(?P<tag>[^\[:\s]+)(?:\[(?P<pid>\d+)\])?[:\s]+(?P<message>.*)'
      - labels:
          host:
          app: tag
